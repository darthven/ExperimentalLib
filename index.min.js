"use strict";function __extends(t,e){function o(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}Object.defineProperty(exports,"__esModule",{value:!0});var util=require("util"),log4js=require("log4js"),LOGGER=log4js.getLogger(),ComponentLifecycle=function(){function t(t){this.componentId=t,this.setDefaultLifecycleMethods()}return t.prototype.setDefaultLifecycleMethods=function(){var t=this;this.preInitMethod=function(){return LOGGER.info('[Component Lifecycle]: Default pre-init-method is called to the component with id "'+t.componentId+'"')},this.postInitMethod=function(){return LOGGER.info('[Component Lifecycle]: Default post-init-method is called to the component with id "'+t.componentId+'"')},this.beforePropertiesWillBeSetMethod=function(){return LOGGER.info('[Component Lifecycle]: Default before-properties-will-be-set-method is called to the component with id "'+t.componentId+'"')},this.afterPropertiesWereSetMethod=function(){return LOGGER.info('[Component Lifecycle]: Default after-properties-were-set-method is called to the component with id "'+t.componentId+'"')},this.preDestroyMethod=function(){return LOGGER.info('[Component Lifecycle]: Default pre-destroy-method is called to the component with id "'+t.componentId+'"')},this.postDestroyMethod=function(){return LOGGER.info('[Component Lifecycle]: Default post-destroy-method is called to the component with id "'+t.componentId+'"')}},t.prototype.getComponentId=function(){return this.componentId},t.prototype.setComponentId=function(t){this.componentId=t},t.prototype.callPreInitMethod=function(){LOGGER.debug('[Component Lifecycle]: Before Component with id "'+this.getComponentId()+'" will be initialized'),this.preInitMethod()},t.prototype.setPreInitMethod=function(t){this.preInitMethod=t},t.prototype.callPostInitMethod=function(){LOGGER.debug('[Component Lifecycle]: After Component with id "'+this.getComponentId()+'" was initialized'),this.postInitMethod()},t.prototype.setPostInitMethod=function(t){this.postInitMethod=t},t.prototype.callBeforePropertiesWillBeSetMethod=function(){LOGGER.debug('[Component Lifecycle]: Before Component with id "'+this.getComponentId()+'" will receive its properties'),this.beforePropertiesWillBeSetMethod()},t.prototype.setBeforePropertiesWillBeSetMethod=function(t){this.beforePropertiesWillBeSetMethod=t},t.prototype.callAfterPropertiesWereSetMethod=function(){LOGGER.debug('[Component Lifecycle]: After Component with id "'+this.getComponentId()+'" received its properties'),this.afterPropertiesWereSetMethod()},t.prototype.setAfterPropertiesWereSetMethod=function(t){this.afterPropertiesWereSetMethod=t},t.prototype.callPreDestroyMethod=function(){LOGGER.debug('[Component Lifecycle]: Before Component with id "'+this.getComponentId()+'" will be destroyed'),this.preDestroyMethod()},t.prototype.setPreDestroyMethod=function(t){this.preDestroyMethod=t},t.prototype.callPostDestroyMethod=function(){LOGGER.debug('[Component Lifecycle]: After Component with id "'+this.getComponentId()+'" was destroyed'),this.postDestroyMethod()},t.prototype.setPostDestroyMethod=function(t){this.postDestroyMethod=t},t.prototype.setLifecycleMethods=function(t){var e=this;Object.keys(t).forEach(function(o){e[o]&&!util.isNull(t[o])&&(e[o]=t[o])})},t}(),extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])},LifecycleNotFoundError=function(t){function e(e){var o=t.call(this,'Lifecycle of the Component with id "'+e+'" cannot be found in context')||this;return o.name="LifecycleNotFoundError",o}return __extends(e,t),e}(Error),ContextLifecycle=function(){function t(){this.componentLifecycles=new Map}return t.prototype.getComponentLifecycles=function(){return this.componentLifecycles},t.prototype.getLifecycleByComponentId=function(t){var e=this.componentLifecycles.get(t);if(!e)throw new LifecycleNotFoundError(t);return e},t}(),Component=function(){function t(t,e,o,n){this.id=t||null,this.componentName=e||null,this.classPath=o||null,this.scope=n||0}return t.prototype.getId=function(){return this.id},t.prototype.getComponentName=function(){return this.componentName},t.prototype.getClassPath=function(){return this.classPath},t.prototype.getScope=function(){return this.scope},t.prototype.getEntityInstance=function(){return this.entityInstance},t.prototype.setEntityInstance=function(t){this.entityInstance=t},t}(),ComponentNotFoundError=function(t){function e(e){var o=t.call(this,'Component with id "'+e+'" cannot be found in context')||this;return o.name="ComponentNotFoundError",o}return __extends(e,t),e}(Error),_=require("lodash"),Context=function(){function t(){this.contextLifecycle=new ContextLifecycle,this.components=new Map}return t.prototype.getContextLifecycle=function(){return this.contextLifecycle},t.prototype.getComponents=function(){return this.components},t.prototype.removeComponentFromContext=function(t){return this.components.delete(t)},t.prototype.close=function(){var t=this;LOGGER.info("[Context]: Closing current context..."),this.components.forEach(function(e){var o=t.contextLifecycle.getComponentLifecycles().get(e.getId());o.callPreDestroyMethod(),t.removeComponentFromContext(e.getId()),o.callPostDestroyMethod()}),LOGGER.info("[Context]: Context is closed..."),this.components.clear()},t.prototype.getComponentEntityInstance=function(t){var e=this.components.get(t);if(!e)throw new ComponentNotFoundError(t);return 1===e.getScope()?_.cloneDeep(e.getEntityInstance()):e.getEntityInstance()},t.prototype.registerShutdownHook=function(){var t=this;process.on("exit",function(){t.close()}),process.on("SIGINT",function(){t.close()})},t}(),LifecycleValidator=function(){function t(){}return t.lifecycleExistsInConfiguration=function(t){return!util.isUndefined(t)&&!util.isUndefined(t.lifecycle)&&util.isObject(t.lifecycle)},t.validateMethod=function(t){return!util.isUndefined(t)&&util.isFunction(t)},t.getLifecycleMethodsDesriptor=function(e,o){var n={};return Object.keys(o.lifecycle).forEach(function(i){var r=e[o.lifecycle[i]];n[i]=t.validateMethod(r)?r:null}),n},t.validateLifecycle=function(e,o,n){var i=new ComponentLifecycle(n.id);if(t.lifecycleExistsInConfiguration(n)){var r=t.getLifecycleMethodsDesriptor(o,n);i.setLifecycleMethods(r)}e.getContextLifecycle().getComponentLifecycles().set(n.id,i)},t}(),PropertyValidator=function(){function t(){}return t.validateName=function(t){return null!=t.name&&util.isString(t.name)},t.validateValue=function(t){return null!=t.value},t.validateReference=function(t){return null!=t.reference&&util.isObject(t.reference)},t.validateProperties=function(e){return e.forEach(function(e){if(e.value){if(e.value&&(!t.validateName(e)||!t.validateValue(e)))return!1}else if(!t.validateName(e)||!t.validateReference(e))return!1}),!0},t}(),MetadataValidationError=function(t){function e(e){var o=this,n='Metadata validation was failed in file "'+e+'".';return o=t.call(this,n)||this,o.name="MetadataValidationError",o}return __extends(e,t),e}(Error),jsonfile$1=require("jsonfile"),path=require("path"),fs=require("fs"),PROPERTY_LENGTH=2,MetadataValidator=function(){function t(){}return t.validateConfigurationFiles=function(t){var e=[];return t.forEach(function(t){try{fs.statSync(t),LOGGER.debug('[Metadata Validation]: Configuration file by path "'+t+'" was found'),e.push({path:t,content:jsonfile$1.readFileSync(t)})}catch(e){LOGGER.error('[Metadata Validation]: Cannot read the file by the following path: "'+t+'".')}}),e},t.validateConfigurationObjects=function(t){var e=[];return t.forEach(function(t){var o=t.content.configuration;if(!o)throw LOGGER.error('[Metadata Validation]: Configuration object from metadata in file "'+t.path+'" does not exist'),new MetadataValidationError(t.path);e.push({filePath:t.path,configuration:o})}),e},t.validateComponentsArray=function(e){e.forEach(function(e){var o=e.configuration.components;if(!o)throw LOGGER.error("[Metadata Validation]: Components' array from metadata in file \""+e.filePath+'" does not exist'),new MetadataValidationError(e.filePath);var n={filePath:e.filePath,components:o};t.validateConfigComponent(n)})},t.validateConfigComponent=function(e){e.components.forEach(function(o,n){if(!util.isObject(o))throw LOGGER.error("[Metadata Validation]: Component["+n+'] from metadata in file "'+e.filePath+'" is not an object'),new MetadataValidationError(e.filePath);var i={index:n,instance:o,filePath:e.filePath};t.validateConfigLifecycle(i),t.validateConfigScope(i),t.validateConfigProperties(i)})},t.configLifecycleHasMethod=function(t,e){return t.hasOwnProperty(e)&&util.isString(t[e])},t.validateConfigLifecycle=function(e){var o=e.instance.lifecycle;if(o){if(!util.isObject(o))throw LOGGER.error("[Metadata Validation]: Component["+e.index+'] from metadata in file "'+e.filePath+'" has invalid lifecycle object'),new MetadataValidationError(e.filePath);Object.keys(o).forEach(function(n){if(!t.configLifecycleHasMethod(o,n))throw LOGGER.error("[Metadata Validation]: Component["+e.index+'] from metadata in file "'+e.filePath+'" has invalid lifecycle object'),new MetadataValidationError(e.filePath)}),LOGGER.debug("[Metadata Validation]: Lifecycle of the Component["+e.index+'] from metadata in file "'+e.filePath+'" is successfully validated')}else LOGGER.warn("[Metadata Validation]: Component["+e.index+'] from metadata in file "'+e.filePath+'" has no lifecycle object')},t.configPropertyHasName=function(t){return t.hasOwnProperty("name")&&util.isString(t.name)},t.configPropertyHasValue=function(t){return t.hasOwnProperty("value")&&!util.isNullOrUndefined(t.value)},t.configPropertyHasReference=function(t){return t.hasOwnProperty("reference")&&util.isString(t.reference)},t.validateConfigProperties=function(e){var o=e.instance.properties;if(!util.isArray(o))throw LOGGER.error("[Metadata Validation]: Component["+e.index+'] from metadata in file "'+e.filePath+"\"has invalid properties' instance"),new MetadataValidationError(e.filePath);o.forEach(function(o){if(Object.keys(o).length===PROPERTY_LENGTH&&t.configPropertyHasName(o)){if(!t.configPropertyHasValue(o)&&!t.configPropertyHasReference(o))throw LOGGER.error("[Metadata Validation]: Component["+e.index+'] from metadata in file "'+e.filePath+' has invalid property "'+o.name+'"'),new MetadataValidationError(e.filePath);LOGGER.debug('[Metadata Validation]: Property "'+o.name+'" of the Component['+e.index+'] from metadata in file "'+e.filePath+" is successfully validated")}})},t.validateConfigScope=function(t){var e=t.instance.scope;if(e){if(!util.isString(e)||!["singleton","prototype"].includes(e))throw LOGGER.error("[Metadata Validation]: Component["+t.index+'] from metadata in file "'+t.filePath+'" has invalid scope'),new MetadataValidationError(t.filePath);LOGGER.debug("[Metadata Validation]: Scope of the Component["+t.index+'] from metadata in file "'+t.filePath+" is successfully validated")}else LOGGER.debug("[Metadata Validation]: Scope of the Component["+t.index+'] from metadata in file "'+t.filePath+'" will be set to SINGLETON as default')},t.validateMetadata=function(e){LOGGER.info("[Metadata Validation]: Metadata validation process is starting...");var o=t.validateConfigurationFiles(e),n=t.validateConfigurationObjects(o);t.validateComponentsArray(n),LOGGER.info("[Metadata Validation]: Metadata validation process was finished...")},t}(),PropertyValidationError=function(t){function e(e){var o=this,n='Component with id "'+e+'" contains wrong property.';return o=t.call(this,n)||this,o.name="PropertyValidationError",o}return __extends(e,t),e}(Error),jsonfile=require("jsonfile"),APPLICATION_ROOT_DIRECTORY=require("app-root-dir").get(),MetadataContext=function(t){function e(e){var o=t.call(this)||this;return e&&(MetadataValidator.validateMetadata(e),o.configs=e,o.registerComponentsInContext(),LOGGER.info("[MetadataContext]: Context was initialized")),o}return __extends(e,t),e.prototype.parseMetadataFromConfigurationFile=function(){var t=[];return this.configs.forEach(function(e){var o=jsonfile.readFileSync(e).configuration;t.push({configName:e,config:o})}),t},e.prototype.getPropertiesFromConfiguration=function(t,e){var o=t.properties,n=[];return o&&o.forEach(function(t){var o=Object.getOwnPropertyNames(e.default.prototype).find(function(e){return e===t.name});t.value&&o?n.push({name:t.name,value:t.value}):t.reference&&o&&n.push({name:t.name,reference:t.reference})}),n},e.prototype.defineComponentScope=function(t){return"singleton"===t.scope?0:"prototype"===t.scope?1:0},e.prototype.setBasicPropertiesToComponents=function(t){var e=this;t.forEach(function(t){var o=APPLICATION_ROOT_DIRECTORY+"/"+t.classPath,n=require(o),i=n.default.prototype,r=Object.create(i);LifecycleValidator.validateLifecycle(e,i,t);var a=e.getContextLifecycle().getComponentLifecycles().get(t.id);a.callPreInitMethod();var c=new Component(t.id,t.name,t.classPath,e.defineComponentScope(t)),f=e.getPropertiesFromConfiguration(t,n);if(!PropertyValidator.validateProperties(f))throw new PropertyValidationError(t.id);f.forEach(function(t){t.value?r[t.name]=t.value:r[t.name]=null}),a.callBeforePropertiesWillBeSetMethod(),c.setEntityInstance(r),e.components.set(t.id,c),a.callPostInitMethod()})},e.prototype.setReferencesToComponents=function(t){var e=this;this.components.forEach(function(o){var n=e.getContextLifecycle().getComponentLifecycles().get(o.getId()),i=require(APPLICATION_ROOT_DIRECTORY+"/"+o.getClassPath());t.forEach(function(t){e.getPropertiesFromConfiguration(t,i).forEach(function(t){if(t.reference){var n=e.getComponentEntityInstance(t.reference);o.getEntityInstance()[t.name]=n}})}),n.callAfterPropertiesWereSetMethod()})},e.prototype.getUniqueConfigComponents=function(){var t=[];return this.parseMetadataFromConfigurationFile().forEach(function(e){e.config.components.forEach(function(e){t.find(function(t){return t.id===e.id})||t.push(e)})}),t},e.prototype.getConfigComponents=function(){return this.getUniqueConfigComponents()},e.prototype.registerComponentsInContext=function(){var t=this.getConfigComponents();this.setBasicPropertiesToComponents(t),this.setReferencesToComponents(t)},e.prototype.updateContext=function(){this.registerComponentsInContext()},e}(Context),DecoratorContext$$1=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Context);exports.MetadataContext=MetadataContext,exports.DecoratorContext=DecoratorContext$$1;
